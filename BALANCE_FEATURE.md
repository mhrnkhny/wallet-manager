# قابلیت مدیریت موجودی کارت‌ها

## خلاصه
سیستم مدیریت موجودی به صورت خودکار موجودی کارت‌ها را بر اساس تراکنش‌ها به‌روزرسانی می‌کند.

## تغییرات دیتابیس

### فیلد جدید در جدول `bank_cards`:
```sql
balance DECIMAL(15, 2) NOT NULL DEFAULT 0.00
```

### اجرای Migration:
```bash
node run-balance-migration.js
```

## نحوه کار سیستم

### 1. افزودن کارت جدید
- موجودی اولیه را می‌توان هنگام افزودن کارت مشخص کرد
- اگر موجودی اولیه داده نشود، به صورت پیش‌فرض 0 تومان خواهد بود

### 2. ثبت تراکنش واریز (Deposit)
```
موجودی جدید = موجودی فعلی + مبلغ واریزی
```

**مثال:**
- موجودی فعلی: 1,000,000 تومان
- مبلغ واریز: 500,000 تومان
- موجودی جدید: 1,500,000 تومان

### 3. ثبت تراکنش برداشت (Withdrawal)
```
موجودی جدید = موجودی فعلی - مبلغ برداشت
```

**مثال:**
- موجودی فعلی: 1,000,000 تومان
- مبلغ برداشت: 300,000 تومان
- موجودی جدید: 700,000 تومان

### 4. بررسی موجودی کافی
قبل از ثبت تراکنش برداشت، سیستم بررسی می‌کند که:
```
مبلغ برداشت <= موجودی فعلی
```

اگر موجودی کافی نباشد، خطای زیر نمایش داده می‌شود:
```
"موجودی کافی نیست. موجودی فعلی: XXX,XXX تومان"
```

## ویژگی‌های امنیتی

### 1. Database Transaction
تمام عملیات در یک transaction انجام می‌شوند:
```javascript
BEGIN TRANSACTION
  1. Insert transaction
  2. Update card balance
COMMIT
```

اگر هر مرحله‌ای fail شود، تمام تغییرات rollback می‌شوند.

### 2. Validation
- بررسی مالکیت کارت توسط کاربر
- بررسی موجودی کافی برای برداشت
- استفاده از parseFloat برای اطمینان از صحت محاسبات

## تغییرات API

### GET /api/cards
**قبل:**
```json
{
  "id": 1,
  "card_number": "1234567812345678",
  "bank_name": "بانک ملی"
}
```

**بعد:**
```json
{
  "id": 1,
  "card_number": "1234567812345678",
  "bank_name": "بانک ملی",
  "balance": 1000000.00
}
```

### POST /api/cards
**Request Body:**
```json
{
  "cardNumber": "1234567812345678",
  "bankName": "بانک ملی",
  "cardHolderName": "محمد احمدی",
  "initialBalance": 1000000
}
```

### POST /api/transactions
**Success Response:**
```json
{
  "success": true,
  "transaction": {
    "id": 1,
    "amount": 500000,
    "transactionType": "deposit"
  },
  "newBalance": 1500000
}
```

**Error Response (موجودی ناکافی):**
```json
{
  "error": "موجودی کافی نیست. موجودی فعلی: 1,000,000 تومان"
}
```

## تغییرات Frontend

### 1. فرم افزودن کارت
فیلد جدید "موجودی اولیه" اضافه شده است:
```tsx
<TextField
  label="موجودی اولیه (اختیاری)"
  value={formData.initialBalance}
  helperText="موجودی فعلی کارت به تومان"
/>
```

### 2. نمایش موجودی در کارت
موجودی به صورت برجسته در هر کارت نمایش داده می‌شود:
```tsx
<div className="p-2 rounded-xl bg-white/10">
  <p>موجودی</p>
  <p>{formatCurrency(balance)}</p>
</div>
```

## سناریوهای استفاده

### سناریو 1: افزودن کارت با موجودی اولیه
1. کاربر کارت جدید اضافه می‌کند
2. موجودی اولیه: 5,000,000 تومان
3. کارت با موجودی 5,000,000 تومان ذخیره می‌شود

### سناریو 2: واریز به کارت
1. موجودی فعلی: 5,000,000 تومان
2. کاربر تراکنش واریز 2,000,000 تومان ثبت می‌کند
3. موجودی جدید: 7,000,000 تومان

### سناریو 3: برداشت موفق
1. موجودی فعلی: 7,000,000 تومان
2. کاربر تراکنش برداشت 1,000,000 تومان ثبت می‌کند
3. موجودی جدید: 6,000,000 تومان

### سناریو 4: برداشت ناموفق (موجودی ناکافی)
1. موجودی فعلی: 6,000,000 تومان
2. کاربر تراکنش برداشت 10,000,000 تومان ثبت می‌کند
3. خطا: "موجودی کافی نیست. موجودی فعلی: 6,000,000 تومان"
4. تراکنش ثبت نمی‌شود
5. موجودی تغییر نمی‌کند

## نکات مهم

1. ✅ موجودی همیشه با فرمت فارسی (جداکننده هزارگان) نمایش داده می‌شود
2. ✅ تمام محاسبات با دقت 2 رقم اعشار انجام می‌شود
3. ✅ Database transaction تضمین می‌کند که موجودی همیشه صحیح است
4. ✅ نمی‌توان موجودی را منفی کرد (validation در سمت server)
5. ✅ موجودی به صورت realtime بعد از هر تراکنش به‌روز می‌شود

## تست کردن

### 1. تست افزودن کارت:
- کارت جدید با موجودی 1,000,000 تومان اضافه کنید
- بررسی کنید موجودی در لیست کارت‌ها نمایش داده می‌شود

### 2. تست واریز:
- تراکنش واریز 500,000 تومان ثبت کنید
- بررسی کنید موجودی به 1,500,000 تومان افزایش یافته

### 3. تست برداشت موفق:
- تراکنش برداشت 300,000 تومان ثبت کنید
- بررسی کنید موجودی به 1,200,000 تومان کاهش یافته

### 4. تست برداشت ناموفق:
- تراکنش برداشت 2,000,000 تومان ثبت کنید
- بررسی کنید پیام خطای "موجودی کافی نیست" نمایش داده می‌شود
- بررسی کنید موجودی تغییر نکرده است
